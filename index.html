<!DOCTYPE html>
<html>
<head>
  <title>Printing...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: -apple-system, sans-serif; text-align: center; padding: 40px 20px; }
    .btn { display: inline-block; padding: 20px 40px; margin-top: 30px; background: #28a745; color: white; text-decoration: none; border-radius: 8px; font-size: 20px; font-weight: bold; }
    .debug { margin-top:20px; font-size: 12px; color: #333; word-break: break-all; text-align:left; background:#f7f7f7; padding:15px; border-radius:8px;}
  </style>
</head>
<body>

<h3>üîÑ Processing...</h3>

<a id="printBtn" href="#" class="btn">Tap to Print</a>

<div id="debugText" class="debug">Initializing...</div>

<script>
function getZplFromHash() {
  let hash = window.location.hash;
  let match = hash.match(/zpl=([^&]+)/);
  return match && match[1] ? match[1] : "";
}

function sanitizeZpl(zpl) {
  // Remove BOM
  zpl = zpl.replace(/^\uFEFF/, "");
  // Replace non-breaking space with normal space
  zpl = zpl.replace(/\u00A0/g, " ");
  // Remove any non-ASCII characters
  zpl = zpl.replace(/[^\x00-\x7F]/g, "");
  return zpl.trim();
}

function debugHex(str) {
  return Array.from(str.slice(0, 30))
    .map(c => c.charCodeAt(0).toString(16).padStart(2,'0'))
    .join(" ");
}

window.onload = function() {
  let rawZplEncoded = getZplFromHash();

  if (!rawZplEncoded) {
    document.getElementById("debugText").innerText = "‚ùå No ZPL data found in URL (#zpl=...)";
    return;
  }

  // Decode URL-encoded string
  let rawZpl = "";
  try {
    rawZpl = decodeURIComponent(rawZplEncoded);
  } catch(e) {
    rawZpl = rawZplEncoded;
  }

  // Sanitize
  rawZpl = sanitizeZpl(rawZpl);

  // Ensure ZPL ends properly
  if (!rawZpl.includes("^XA")) {
    document.getElementById("debugText").innerText = "‚ùå ZPL does not contain ^XA. Data looks corrupted:\n\n" + rawZpl;
    return;
  }

  if (!rawZpl.trim().endsWith("^XZ")) {
    rawZpl += "^XZ";
  }

  // Add newline to flush print job
  rawZpl += "\r\n";

  // Base64 encode (ASCII safe after sanitization)
  let base64Zpl = btoa(rawZpl);

  // Build deep link
  let deepLink =
    "arrowhead://x-callback-url/zplcode" +
    "?code=" + encodeURIComponent(base64Zpl) +
    "&x-success=" + encodeURIComponent("asana://");

  // Update button link
  document.getElementById("printBtn").href = deepLink;

  // Debug output
  document.getElementById("debugText").innerText =
    "‚úÖ Clean ZPL (first 150 chars):\n" + rawZpl.slice(0, 150) + "\n\n" +
    "‚úÖ HEX (first 30 chars):\n" + debugHex(rawZpl) + "\n\n" +
    "‚úÖ Base64 (first 50 chars):\n" + base64Zpl.slice(0, 50) + "\n\n" +
    "‚úÖ Base64 should start with: XlhB  (this = '^XA')\n\n" +
    "‚úÖ Deep Link:\n" + deepLink;
};
</script>

</body>
</html>
